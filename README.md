# FreezeRay CLI

Command-line tool for freezing SwiftData schemas and scaffolding migration tests.

**This repository contains the CLI tool.** For the Swift package (macros + runtime), see [FreezeRay](https://github.com/TrinsicVentures/FreezeRay).

## What is FreezeRay?

FreezeRay prevents accidental SwiftData schema changes from reaching production by creating immutable schema snapshots (fixtures) and generating validation tests.

The CLI tool (`freezeray`) orchestrates the freezing workflow:
- Auto-detects your Xcode project structure
- Runs tests in iOS Simulator to export schemas
- Extracts fixtures via `/tmp` (works in simulator sandbox)
- Scaffolds drift detection and migration tests
- Auto-adds test files to your Xcode project

## Installation

### Install via npm (Recommended)

```bash
npm install -g @trinsicventures/freezeray
```

Verify installation:
```bash
freezeray --version
```

> **Note:** Apple Silicon (ARM64) only. Intel Mac users should build from source.

### Alternative: Build from Source

For Intel Macs or if you prefer to build from source:

```bash
git clone https://github.com/TrinsicVentures/FreezeRayCLI.git
cd FreezeRayCLI
swift build -c release
cp .build/release/freezeray /usr/local/bin/
```

## Requirements

- **macOS 14+** (CLI requirement)
- **Xcode 16+** (Swift 6.0 support)
- **FreezeRay package** must be added to your Xcode project

## Usage

### Initialize Your Project

```bash
cd /path/to/your/project
freezeray init
```

This:
- Creates `FreezeRay/Fixtures/` and `FreezeRay/Tests/` directories
- Adds FreezeRay folder as yellow folder reference (auto-syncs with filesystem)
- Adds FreezeRay package dependency
- Configures test target to include fixtures as bundle resources

### Freeze a Schema Version

```bash
freezeray freeze 1.0.0
```

This command:
- Discovers schemas annotated with `@FreezeSchema(version: "1.0.0")`
- Builds and runs your app in iOS Simulator
- Exports schema to `FreezeRay/Fixtures/1.0.0/`
- Generates checksums for drift detection
- Scaffolds drift detection test (if doesn't already exist)
- Auto-adds test files to your Xcode project

**What gets generated:**
```
FreezeRay/
├── Fixtures/
│   └── 1.0.0/
│       ├── App-1_0_0.sqlite
│       ├── schema-1_0_0.json
│       ├── schema-1_0_0.sql
│       ├── schema-1_0_0.sha256
│       └── export_metadata.txt
└── Tests/
    └── SchemaV1_DriftTests.swift  (auto-added to test target)
```

### Generate Migration Tests (Essential for Schema Changes)

**When you're ready to work on a new schema version**, generate the migration test:

```bash
# 1. Freeze V1
freezeray freeze 1.0.0

# 2. Generate migration test WHEN STARTING V2 work
freezeray generate migration-tests --from-schema 1.0.0 --to-schema 2.0.0

# 3. Edit the generated test, add custom assertions
# 4. Implement V2 schema + migration
# 5. Iterate: run tests normally (⌘U or xcodebuild test)

# 6. Freeze V2
freezeray freeze 2.0.0
```

<Info>
**Migration tests are NOT generated by `freeze`**. You must explicitly run `generate migration-tests` when starting work on a new schema version.
</Info>

This workflow lets you write and test your migration **as you develop** the new schema version.

#### Other Generate Commands

```bash
# Generate only fixtures (advanced - rarely needed, freeze does this)
freezeray generate fixtures --schema 3.0.0

# Generate only drift tests (advanced - rarely needed, freeze does this)
freezeray generate schema-tests --schema 3.0.0
```

### Run Tests

Press ⌘U in Xcode or:
```bash
xcodebuild test \
  -project YourApp.xcodeproj \
  -scheme YourApp \
  -destination 'platform=iOS Simulator,name=iPhone 17'
```

### Options

```bash
freezeray init --help
freezeray freeze --help
freezeray generate --help
freezeray generate migration-tests --help
```

Common options:
- `--project <path>` - Path to .xcodeproj (auto-detected if only one exists)
- `--scheme <name>` - Scheme name (auto-detected from project name)
- `--simulator <name>` - Simulator name (default: "iPhone 17")
- `--force` - Overwrite existing fixtures/tests (use with caution!)

### Commands

| Command | Description |
|---------|-------------|
| `init` | Initialize FreezeRay in your project |
| `freeze <version>` | Freeze a schema version (all-in-one) |
| `generate fixtures` | Generate frozen fixtures only |
| `generate schema-tests` | Generate drift tests only |
| `generate migration-tests` | Generate migration test only |

## Development

### Build & Test

```bash
swift build          # Build CLI
swift test           # Run 26 unit tests
```

### Testing with Local Changes

If you're developing both FreezeRay package and CLI simultaneously:

1. Update Package.swift to use local path:
```swift
.package(path: "../FreezeRay"),
```

2. Build and test:
```bash
swift build && swift test
```

## Repository Structure

```
FreezeRayCLI/
├── Sources/
│   ├── freezeray-cli/            # CLI library (testable)
│   │   ├── Commands/
│   │   │   ├── InitCommand.swift       # Initialize project
│   │   │   ├── FreezeCommand.swift     # All-in-one freeze workflow
│   │   │   ├── GenerateCommand.swift   # Fine-grained artifact generation (new!)
│   │   │   └── TestScaffolding.swift   # Test generation helper
│   │   ├── Parser/
│   │   │   └── MacroDiscovery.swift    # SwiftSyntax AST parsing
│   │   ├── Simulator/
│   │   │   └── SimulatorManager.swift  # iOS Simulator orchestration
│   │   └── CLI.swift                   # Command registration
│   └── freezeray-bin/            # CLI executable (thin wrapper)
│       └── main.swift
├── Tests/
│   └── FreezeRayCLITests/        # 22 unit tests
│       ├── FreezeCommandTests.swift
│       ├── InitCommandTests.swift
│       └── SimulatorManagerTests.swift
├── release/
│   └── npm/                       # npm package configuration
│       ├── package.json
│       └── README.md
├── docs/                          # Mintlify documentation
│   ├── cli/
│   │   ├── init.mdx
│   │   ├── freeze.mdx
│   │   └── generate.mdx            # New: generate command docs
│   ├── guides/
│   │   ├── testing-migrations.mdx  # Updated: early generation workflow
│   │   └── ...
│   └── docs.json
├── .mise.toml                     # Build and publish tasks
└── Package.swift
```

## Documentation

Full documentation available at: **[docs.freezeray.dev](https://docs.freezeray.dev)**

## Related Projects

- **[FreezeRay](https://github.com/TrinsicVentures/FreezeRay)** - Swift package (macros + runtime)

## Contributing

See the main [FreezeRay repository](https://github.com/TrinsicVentures/FreezeRay) for contributing guidelines and architecture documentation.

## License

MIT License - See [LICENSE](LICENSE) for details

---

**Maintained by:** Geordie Kaytes ([@didgeoridoo](https://github.com/didgeoridoo))
**Organization:** [Trinsic Ventures](https://github.com/TrinsicVentures)
