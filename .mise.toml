# mise configuration for FreezeRayCLI
# https://mise.jdx.dev/

[tasks.build]
description = "Build CLI binary for release"
run = "swift build -c release --arch arm64"

[tasks.test]
description = "Run unit tests"
run = "swift test"

[tasks."publish:npm"]
description = "Publish CLI to npm"
depends = ["build"]
run = """
#!/bin/bash
set -e

echo "üì¶ Publishing FreezeRay CLI to npm..."

# Version sync check
echo "üîç Checking version sync..."
CLI_VERSION=$(grep 'version:' Sources/freezeray-cli/CLI.swift | sed -E 's/.*version: "([0-9.]+)".*/\1/')
NPM_VERSION=$(grep '"version"' release/npm/package.json | sed -E 's/.*"version": "([0-9.]+)".*/\1/')

if [ "$CLI_VERSION" != "$NPM_VERSION" ]; then
  echo "‚ùå ERROR: Version mismatch!"
  echo "   CLI.swift: $CLI_VERSION"
  echo "   package.json: $NPM_VERSION"
  echo ""
  echo "Update versions in:"
  echo "  - Sources/freezeray-cli/CLI.swift"
  echo "  - Sources/freezeray-cli/Commands/FreezeCommand.swift"
  echo "  - release/npm/package.json"
  exit 1
fi

echo "‚úÖ Versions synced: v$CLI_VERSION"
echo ""
echo "‚ö†Ô∏è  REMINDER: After publishing, tag FreezeRayPkg at v$CLI_VERSION for version sync"
echo "   cd ../FreezeRayPkg && git tag v$CLI_VERSION -m 'Version sync with FreezeRayCLI v$CLI_VERSION'"
echo ""

# Copy binary to npm release folder
mkdir -p release/npm/bin
cp .build/release/freezeray release/npm/bin/freezeray
chmod +x release/npm/bin/freezeray

# Verify
echo "‚úÖ Binary copied ($(du -h release/npm/bin/freezeray | cut -f1))"

# Publish
cd release/npm
npm publish --access public

echo "‚úÖ Published to npm!"
echo ""
echo "Test with: npm install -g @trinsicventures/freezeray"
"""

[tasks.clean]
description = "Clean build artifacts"
run = """
swift package clean
rm -f release/npm/bin/freezeray
rm -f release/npm/*.tgz
"""
